// -------------------------------------------
// Offline indicator
// -------------------------------------------
function updateOfflineStatus() {
  const ind = document.getElementById("offline-indicator");
  if (navigator.onLine) {
    ind.textContent = "Online";
    ind.classList.remove("offline");
    ind.classList.add("online");
  } else {
    ind.textContent = "Offline";
    ind.classList.remove("online");
    ind.classList.add("offline");
  }
}
window.addEventListener("online", updateOfflineStatus);
window.addEventListener("offline", updateOfflineStatus);
updateOfflineStatus();


// -------------------------------------------
// LocalStorage Save + Load
// -------------------------------------------
const fields = ["symbol","capital","entry","tp","sl","fee"];

function loadSaved() {
  fields.forEach(id=>{
    const val = localStorage.getItem("spot_"+id);
    if(val!==null) document.getElementById(id).value = val;
  });
}

function saveField(id) {
  localStorage.setItem("spot_"+id, document.getElementById(id).value);
}

fields.forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>saveField(id));
});

loadSaved();


// -------------------------------------------
// Spot Calculator
// -------------------------------------------
document.getElementById("spot-calc-btn").addEventListener("click", ()=>{

  const symbol  = document.getElementById("symbol").value.trim();
  const capital = parseFloat(document.getElementById("capital").value);
  const entry   = parseFloat(document.getElementById("entry").value);
  const tp      = parseFloat(document.getElementById("tp").value);
  const slVal   = document.getElementById("sl").value;
  const sl      = slVal ? parseFloat(slVal) : null;
  const feePct  = parseFloat(document.getElementById("fee").value);

  const out = document.getElementById("spot-result");

  if (!capital || !entry || !tp) {
    out.innerHTML = `<div class='error'>Please fill Capital, Entry and TP</div>`;
    return;
  }

  // position size
  const size = capital / entry;

  // profit to TP
  const grossProfit = (tp - entry) * size;

  // fees
  const feeRate = feePct / 100;
  const feeEntry = size * entry * feeRate;
  const feeExit  = size * tp    * feeRate;
  const totalFees = feeEntry + feeExit;

  const netProfit = grossProfit - totalFees;
  const roe = (netProfit / capital) * 100;

  // risk block
  let riskBlock = "";
  if(sl){
    const grossLoss = (entry - sl) * size;
    const feeSlExit = size * sl * feeRate;
    const netLoss = grossLoss + feeEntry + feeSlExit;
    const riskPct = (netLoss / capital) * 100;
    const rr = netLoss > 0 ? (netProfit / netLoss) : null;

    riskBlock = `
      <br><b>SL Risk:</b><br>
      Loss: -${netLoss.toFixed(2)} $<br>
      Risk %: -${riskPct.toFixed(2)} %<br>
      R:R = ${rr ? rr.toFixed(2) : "—"}
    `;
  }

  out.innerHTML = `
    <b>Symbol:</b> ${symbol || "—"} <br>
    <b>Position Size:</b> ${size.toFixed(6)} ${symbol}<br>
    <b>Gross Profit:</b> ${grossProfit.toFixed(2)} $<br>
    <b>Total Fees:</b> ${totalFees.toFixed(2)} $<br>
    <b>Net Profit:</b> ${netProfit.toFixed(2)} $<br>
    <b>ROE:</b> ${roe.toFixed(2)} %
    ${riskBlock}
  `;

  drawChart(entry, tp, sl);
});


// -------------------------------------------
// Chart
// -------------------------------------------
function drawChart(entry, tp, sl){
  const box = document.getElementById("spot-chart");
  box.innerHTML = "";

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("width","100%");
  svg.setAttribute("height","180");

  const prices = [entry, tp];
  if(sl) prices.push(sl);

  const minP = Math.min(...prices);
  const maxP = Math.max(...prices);

  const y = v => 160 - ((v - minP) / (maxP - minP)) * 140;

  function line(val, color, label){
    const g = document.createElementNS(svg.namespaceURI,"g");

    const l = document.createElementNS(svg.namespaceURI,"line");
    l.setAttribute("x1","20");
    l.setAttribute("x2","95%");
    l.setAttribute("y1",y(val));
    l.setAttribute("y2",y(val));
    l.setAttribute("stroke",color);
    l.setAttribute("stroke-width","2");
    g.appendChild(l);

    const t = document.createElementNS(svg.namespaceURI,"text");
    t.setAttribute("x","25");
    t.setAttribute("y", y(val)-5);
    t.setAttribute("fill", color);
    t.setAttribute("font-size","12");
    t.textContent = `${label}: ${val}`;
    g.appendChild(t);

    svg.appendChild(g);
  }

  line(entry, "#4bb8ff", "Entry");
  line(tp, "#51ff84", "TP");
  if(sl) line(sl, "#ff5e5e", "SL");

  box.appendChild(svg);
}
